{% extends "neurocity/base.html" %}
{% load i18n %}

{% block content %}
 
<!-- Modal -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3 id="myModalLabel">Why is this a bad match?</h3>
  </div>
  <div class="modal-body">
    <!-- TODO: select a category of unclear -->
    <label>
      <input type="checkbox" name="reason" id="more-than-one-candidate" value="more-than-one-candidate"> More than one neuron candidate</label>
    <label>
      <input type="checkbox" name="reason" value="not-fit-boundary"> Bad fit to membrane</label>
    <label>
      <input type="checkbox" name="reason" value="candidate-shifted"> Neuron candidate is shifted</label>
    <label>
      <input type="checkbox" name="reason" value="should-be-branch"> Should be branch</label>
    <label>
      <input type="checkbox" name="reason" value="not-completely-covered"> Neuron candidate match, but not covered completely</label>
    <label>
      <input type="checkbox" name="reason" value="only-mitochondria"> Only mitochondria is covered</label>
    <label>
      <input type="checkbox" name="reason" value="good-match-but-small-dent"> Almost good match, but small dent</label>
    <input type="checkbox" name="reason" value=""> ...</label>
    <br />
    Other reason: <input type="text" id="commentfield" maxlength="50" size="50">
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    <button class="btn btn-primary" id="submitvote">Submit</button>
  </div>
</div>

<div align="center">
  {% if not nc_segmentonly %}
    <a class="btn btn-large btn-primary btn-success" href="#" id='buttongood'>Good (A)</a>
    <a class="btn btn-large btn-primary btn-danger" href="#" id='buttonbad'>Bad (S)</a>
    <a class="btn btn-large btn-primary btn-warning" href="#" id='buttonunclear'>Bad & Comment (D)</a>
    <br /><br />
  {% endif %}
  <div id="help" style="position:absolute; right:80px; top:100px">
    <p align="right">
      <a class="btn btn-medium btn-primary btn-info" href="#" id='buttontoggle'>Toggle (T)</a><br />
      {% if not nc_segmentonly %}
      <a class="btn btn-medium btn-primary btn-info" href="#" id='buttonskip'>Skip (X)</a><br />
      <a class="btn btn-medium btn-primary btn-info" href="#" id='buttongeturl'>Share link</a><br />
      {% endif %}
    </p>
  </div>
  <table>
    <tr>
      <td>
        <canvas id="c2" style="border:0px solid #aaa"></canvas>
      </td>
      <td>
        <canvas id="c3" style="border:0px solid #aaa"></canvas>
      </td>
    </tr>
  </table>

  <!-- TODO: additional canvases with adjacent slices for more context -->
  <!-- <canvas id="c1" width="200" height="200" style="border:1px solid #aaa"></canvas> -->
  <!-- <canvas id="c4" width="200" height="200" style="border:1px solid #aaa"></canvas> -->

  <br />

  <h4>Artificial Intelligence estimates a cost of {{ cost }}.</h4>
<!-- TODO: Contributors say ;..... -->

  <script type="text/javascript" src="{{ STATIC_URL }}libs/fabric.js/all.js"></script>
  <script type="text/javascript">

var canvas2 = new fabric.Canvas('c2'),
    canvas3 = new fabric.Canvas('c3'),
    border = 80, show_slices = true,
    radius = 300, origin_slices = [], target_slices = [],
    start;

      $.ajax({
        "dataType": 'json',
        "type": "GET",
        "cache": false,
        "url": 'segment-bb',
        "data": {
          'originsection': {{ originsection }},
          'targetsection': {{ targetsection }},
          'segmentid': {{ segmentid }},
        },
        "success": function(data) {

           canvas2.setWidth(data['totalbb']['width']+2*border);
           canvas2.setHeight(data['totalbb']['height']+2*border);
           canvas2.renderAll();
           canvas2.selection = false;

           canvas3.setWidth(data['totalbb']['width']+2*border);
           canvas3.setHeight(data['totalbb']['height']+2*border);
           canvas3.renderAll();
           canvas3.selection = false;

           tile_col_min = Math.floor( (data['totalbb']['min_x'] - border) / data['tile_width']);
           tile_col_max = Math.ceil( (data['totalbb']['max_x'] + border) / data['tile_width'] );
           tile_row_min = Math.floor( (data['totalbb']['min_y'] - border) / data['tile_height'] );
           tile_row_max = Math.ceil( (data['totalbb']['max_y'] + border) / data['tile_height'] );
           
           tile_left_offset = (data['totalbb']['min_x'] - border) - tile_col_min * data['tile_width'];
           tile_top_offset = (data['totalbb']['min_y'] - border) - tile_row_min * data['tile_height'];

           var build_callback2 = function (xi, yi) {
                return function(img) {
                    img.set({
                      left: -tile_left_offset + data['tile_width'] / 2. + data['tile_width'] * (xi - tile_col_min),
                      top: -tile_top_offset + data['tile_height'] / 2. + data['tile_height'] * (yi - tile_row_min),
                    });
                    img.hasControls = img.hasBorders = false;
                    img.lockMovementX = img.lockMovementY = true;
                    canvas2.add(img).sendToBack(img);
                };
              },
              build_callback3 = function (xi, yi) {
                return function(img) {
                    img.set({
                      left: -tile_left_offset + data['tile_width'] / 2. + data['tile_width'] * (xi - tile_col_min),
                      top: -tile_top_offset + data['tile_height'] / 2. + data['tile_height'] * (yi - tile_row_min),
                    });
                    img.hasControls = img.hasBorders = false;
                    img.lockMovementX = img.lockMovementY = true;
                    canvas3.add(img).sendToBack(img);
                };
              };

           for(var xi = tile_col_min; xi < tile_col_max; xi++) {
            for(var yi = tile_row_min; yi < tile_row_max; yi++) {

              fabric.Image.fromURL('{{ tile_base_url }}{{ originsection }}/'+yi+'_'+xi+'_0.jpg', build_callback2(xi, yi));

              fabric.Image.fromURL('{{ tile_base_url }}{{ targetsection }}/'+yi+'_'+xi+'_0.jpg', build_callback3(xi, yi));

            }
           }

           var slice_callback2 = function (slice2_left_offset, slice2_top_offset) {
                return function(img) {
                    img.set({
                      left: slice2_left_offset,
                      top: slice2_top_offset,
                    });
                    img.hasControls = img.hasBorders = false;
                    img.lockMovementX = img.lockMovementY = true;
                    img.opacity = 0.8;
                    canvas2.add(img).bringToFront(img);
                    origin_slices.push( img );
                };
              };

           // add slices to canvas, need to be in the foreground
           for(var sliceidx = 0; sliceidx < data['originsection'].length; sliceidx++) {
              var slice_left_offset = data['originsection'][sliceidx]['min_x'] - data['totalbb']['min_x'] + border + data['originsection'][sliceidx]['width'] / 2. ,
                slice_top_offset = data['originsection'][sliceidx]['min_y'] - data['totalbb']['min_y'] + border  + data['originsection'][sliceidx]['height'] / 2.;
              fabric.Image.fromURL(data['originsection'][sliceidx]['slicepath'], 
                slice_callback2( slice_left_offset, slice_top_offset ) );
           }

           var slice_callback3 = function (slice2_left_offset, slice2_top_offset) {
                return function(img) {
                    img.set({
                      left: slice2_left_offset,
                      top: slice2_top_offset,
                    });
                    img.hasControls = img.hasBorders = false;
                    img.lockMovementX = img.lockMovementY = true;
                    img.opacity = 0.8;
                    canvas3.add(img).bringToFront(img);
                    target_slices.push( img );
                };
              };

           for(var sliceidx = 0; sliceidx < data['targetsection'].length; sliceidx++) {
              var slice2_left_offset = data['targetsection'][sliceidx]['min_x'] - data['totalbb']['min_x'] + border + data['targetsection'][sliceidx]['width'] / 2. ,
                slice2_top_offset = data['targetsection'][sliceidx]['min_y'] - data['totalbb']['min_y'] + border  + data['targetsection'][sliceidx]['height'] / 2.;
              fabric.Image.fromURL(data['targetsection'][sliceidx]['slicepath'], 
                slice_callback3( slice2_left_offset, slice2_top_offset ));
           }

        }
      });

    var segmentkey = {{ segmentkey }};

    var hide_slices_image = function() {
      for(var idx = 0; idx < origin_slices.length; idx++) {
        origin_slices[ idx ].setOpacity( 0.3 );
      }
      for(var idx = 0; idx < target_slices.length; idx++) {
        target_slices[ idx ].setOpacity( 0.3 );
      }
      canvas2.renderAll();
      canvas3.renderAll();
    }

    var show_slices_image = function() {
      for(var idx = 0; idx < origin_slices.length; idx++) {
        origin_slices[ idx ].setOpacity( 0.9 );
      }
      canvas2.renderAll();
      for(var idx = 0; idx < target_slices.length; idx++) {
        target_slices[ idx ].setOpacity( 0.9 );
      }
      canvas2.renderAll();
      canvas3.renderAll();
    }

    var vote = function( segmentkey, value, comment ) {
      var data = {
            segmentkey: segmentkey,
            vote: value,
          };
      
      if (comment !== undefined) {
        data['comment'] = comment;
      }

      data['elapsed_time'] = new Date().getTime() - start;

      $.ajax({
        "dataType": 'json',
        "type": "POST",
        "cache": false,
        "url": 'segment-vote',
        "data": data,
        "success": function(data) {
           location.reload();
        }
      });

    }

    var show_unclear_modal = function() {
      $(document).off('keyup'); // disable all key events
      $('#commentfield').val('');
      $('#myModal').on('shown', function() { 
        $('#commentfield').focus();
        $(document).on('keyup', function(e) { 
          if (e.keyCode == 13) { 
            hide_and_submit_modal();
          }
        });
      });
      $('#myModal').on('hidden', function() {
        register_keyevents();
      });
      $('#myModal').modal('show');
    }

    var hide_and_submit_modal = function() {
      $('#myModal').modal('hide');
      var commentvalue = '';
      if( $("#more-than-one-candidate").is(':checked') )
        commentvalue += $("#more-than-one-candidate").val() + ',';

      if( $('#commentfield').val() !== '' )
        commentvalue += $('#commentfield').val();

      vote( segmentkey, 2, commentvalue );
    }

    var skip_segment = function() {
      location.reload();
    }

    var toggle_slice = function() {
      if( show_slices ) {
        show_slices = false;
        hide_slices_image();
      } else {
        show_slices = true;
        show_slices_image();
      }
    }

    var register_keyevents = function() {
      $(document).on('keyup', function(e) { 

        {% if not nc_segmentonly %}
          if (e.keyCode == 65) { 
            vote( segmentkey, 1 );
          }
          if (e.keyCode == 83) {
            vote( segmentkey, 3 );
          }
          if (e.keyCode == 68) {
            show_unclear_modal();
          }
          if (e.keyCode == 88) {
            skip_segment();
          }
        {% endif %}
          if (e.keyCode == 84) {
            toggle_slice();
          }
      });      
    }

    $('#buttonskip').on('click', function() {
      skip_segment();
    });

    $('#buttongeturl').on('click', function() {
      window.open( 'segmentonly?segmentkey={{ segmentkey }}' )
    });

    $('#buttontoggle').on('click', function() {
      toggle_slice();
    });

    $('#buttongood').on('click', function() {
      vote( segmentkey, 1 );
    });

    $('#buttonunclear').on('click', function() {
      show_unclear_modal();
    });

    $('#buttonbad').on('click', function() {
      vote( segmentkey, 3 );
    });

    $('#submitvote').on('click', function() {
      hide_and_submit_modal();
    });

    register_keyevents();

    $(document).ready(function() {
      start = new Date().getTime();
    });

  </script>

</div>

{% endblock %}

