{% extends "neurocity/base.html" %}
{% load i18n %}

{% block content %}

 
<!-- Modal -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3 id="myModalLabel">Add a comment</h3>
  </div>
  <div class="modal-body">
    Tell us why you think the segment is unclear?<br />
    <!-- TODO: select a category of unclear -->
    <input type="checkbox" name="reason" value="not-fit-boundary">Does not fit boundary<br>
    <input type="checkbox" name="reason" value="">Slice shifted<br>
    <input type="checkbox" name="reason" value="">More than one neuron covered<br>
    <input type="checkbox" name="reason" value="">Should be branch<br>
    <input type="checkbox" name="reason" value="">...<br>
    <br />
    Other reason: <input type="text" id="commentfield" maxlength="50" size="50">
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    <button class="btn btn-primary" id="submitvote">Submit comment</button>
  </div>
</div>

<div align="center">

  <a class="btn btn-large btn-primary btn-success" href="#" id='buttongood'>Good (A)</a>
  <a class="btn btn-large btn-primary btn-warning" href="#" id='buttonunclear'>Unclear (S)</a>
  <a class="btn btn-large btn-primary btn-danger" href="#" id='buttonbad'>Bad (D)</a>
  <br /><br />
  <div id="help" style="position:absolute; right:80px; top:100px">
    <p align="right">
      <a class="btn btn-medium btn-primary btn-info" href="#" id='buttontoggle'>Toggle (T)</a><br />
      <a class="btn btn-medium btn-primary btn-info" href="#" id='buttonskip'>Skip (X)</a><br />
    </p>
  </div>
  <table>
    <tr>
      <td>
        <canvas id="c2" style="border:1px solid #aaa"></canvas>
        <!-- <img src="http://localhost:8000/segment/image?originsection={{ originsection }}&targetsection={{ targetsection }}&segmentid={{ segmentid }}&edge=0"> -->
      </td>
      <td>
        <canvas id="c3" style="border:1px solid #aaa"></canvas>
        <!-- <img src="http://localhost:8000/segment/image?originsection={{ originsection }}&targetsection={{ targetsection }}&segmentid={{ segmentid }}&edge=1"> -->
      </td>
    </tr>
  </table>

  <!-- <canvas id="c1" width="200" height="200" style="border:1px solid #aaa"></canvas> -->
  
  
  <!-- <canvas id="c4" width="200" height="200" style="border:1px solid #aaa"></canvas> -->

  <br />

  <h4>Artificial Intelligence says {{ aiguess }}% correct.</h4>

  <script type="text/javascript" src="{{ STATIC_URL }}libs/fabric.js/all.js"></script>
  <script type="text/javascript" >

var canvas2 = new fabric.Canvas('c2'),
    canvas3 = new fabric.Canvas('c3'),
    border = 80,
    show_slices = true;

var radius = 300, origin_slices = [], target_slices = [];

      $.ajax({
        "dataType": 'json',
        "type": "GET",
        "cache": false,
        "url": 'segment-bb',
        "data": {
          'originsection': {{ originsection }},
          'targetsection': {{ targetsection }},
          'segmentid': {{ segmentid }},
        },
        "success": function(data) {
           // console.log('success bb', data ); //data['min_x'], data['max_x'], data['min_y'], data['max_y'])

           // canvas2.setWidth(1000);
           // canvas2.setHeight(1000);
           canvas2.setWidth(data['totalbb']['width']+2*border);
           canvas2.setHeight(data['totalbb']['height']+2*border);
           canvas2.renderAll();
           canvas2.selection = false;

           canvas3.setWidth(data['totalbb']['width']+2*border);
           canvas3.setHeight(data['totalbb']['height']+2*border);
           canvas3.renderAll();
           canvas3.selection = false;

           tile_col_min = Math.floor( (data['totalbb']['min_x'] - border) / data['tile_width']);
           tile_col_max = Math.ceil( (data['totalbb']['max_x'] + border) / data['tile_width'] );
           tile_row_min = Math.floor( (data['totalbb']['min_y'] - border) / data['tile_height'] );
           tile_row_max = Math.ceil( (data['totalbb']['max_y'] + border) / data['tile_height'] );
           // console.log('min row',  (data['totalbb']['min_y'] - border) / data['tile_height'], data['totalbb']['min_y'] - border)
           // console.log('max row', (data['totalbb']['max_y'] + border) / data['tile_height'], data['totalbb']['max_y'] + border)

           tile_left_offset = (data['totalbb']['min_x'] - border) - tile_col_min * data['tile_width'];
           tile_top_offset = (data['totalbb']['min_y'] - border) - tile_row_min * data['tile_height'];

           // console.log('tile_col_min', tile_col_min, 'tile col max', tile_col_max)
           // console.log('tile row min', tile_row_min, 'tile row max', tile_row_max)

           var build_callback2 = function (xi, yi) {
                return function(img) {
                    // console.log('returned2', xi, yi)
                    // console.log('added shift x', data['tile_width'] * (xi - tile_col_min))
                    // console.log('added shift y', data['tile_height'] * (yi - tile_row_min))
                    img.set({
                      left: -tile_left_offset + data['tile_width'] / 2. + data['tile_width'] * (xi - tile_col_min),
                      top: -tile_top_offset + data['tile_height'] / 2. + data['tile_height'] * (yi - tile_row_min),
                    });
                    img.hasControls = img.hasBorders = false;
                    img.lockMovementX = img.lockMovementY = true;
                    canvas2.add(img).sendToBack(img);
                };
              },
              build_callback3 = function (xi, yi) {
                return function(img) {
                    img.set({
                      left: -tile_left_offset + data['tile_width'] / 2. + data['tile_width'] * (xi - tile_col_min),
                      top: -tile_top_offset + data['tile_height'] / 2. + data['tile_height'] * (yi - tile_row_min),
                    });
                    img.hasControls = img.hasBorders = false;
                    img.lockMovementX = img.lockMovementY = true;
                    canvas3.add(img).sendToBack(img);
                };
              };

           for(var xi = tile_col_min; xi < tile_col_max; xi++) {
            for(var yi = tile_row_min; yi < tile_row_max; yi++) {

              fabric.Image.fromURL('http://localhost:8000/static/stack2/raw/{{ originsection }}/'+yi+'_'+xi+'_0.jpg', build_callback2(xi, yi));

              fabric.Image.fromURL('http://localhost:8000/static/stack2/raw/{{ targetsection }}/'+yi+'_'+xi+'_0.jpg', build_callback3(xi, yi));

            }
           }

           // add slices to canvas, need to be in the foreground
           for(var sliceidx = 0; sliceidx < data['originsection'].length; sliceidx++) {
              var slice_left_offset = data['originsection'][sliceidx]['min_x'] - data['totalbb']['min_x'] + border + data['originsection'][sliceidx]['width'] / 2. ,
                slice_top_offset = data['originsection'][sliceidx]['min_y'] - data['totalbb']['min_y'] + border  + data['originsection'][sliceidx]['height'] / 2.;
              fabric.Image.fromURL(data['originsection'][sliceidx]['slicepath'], function(img) {
                img.set({
                  left: slice_left_offset,
                  top: slice_top_offset,
                });
                img.hasControls = img.hasBorders = false;
                img.lockMovementX = img.lockMovementY = true;
                img.opacity = 0.8;
                // img.visible = false;
                canvas2.add(img).bringToFront(img);
                origin_slices.push( img );
              });
           }

           for(var sliceidx = 0; sliceidx < data['targetsection'].length; sliceidx++) {
              var slice2_left_offset = data['targetsection'][sliceidx]['min_x'] - data['totalbb']['min_x'] + border + data['targetsection'][sliceidx]['width'] / 2. ,
                slice2_top_offset = data['targetsection'][sliceidx]['min_y'] - data['totalbb']['min_y'] + border  + data['targetsection'][sliceidx]['height'] / 2.;
              fabric.Image.fromURL(data['targetsection'][sliceidx]['slicepath'], function(img) {
                img.set({
                  left: slice2_left_offset,
                  top: slice2_top_offset,
                });
                img.hasControls = img.hasBorders = false;
                img.lockMovementX = img.lockMovementY = true;
                img.opacity = 0.8;
                canvas3.add(img).bringToFront(img);
                target_slices.push( img );
              });
           }


        }
      });

    var segmentkey = {{ segmentkey }};

    var hide_slices_image = function() {
      for(var idx = 0; idx < origin_slices.length; idx++) {
        origin_slices[ idx ].setOpacity( 0.3 );
      }
      for(var idx = 0; idx < target_slices.length; idx++) {
        target_slices[ idx ].setOpacity( 0.3 );
      }
      canvas2.renderAll();
      canvas3.renderAll();
    }

    var show_slices_image = function() {
      for(var idx = 0; idx < origin_slices.length; idx++) {
        origin_slices[ idx ].setOpacity( 0.9 );
      }
      canvas2.renderAll();
      for(var idx = 0; idx < target_slices.length; idx++) {
        target_slices[ idx ].setOpacity( 0.9 );
      }
      canvas2.renderAll();
      canvas3.renderAll();
    }

    var vote = function( segmentkey, value, comment ) {
      var data = {
            segmentkey: segmentkey,
            vote: value,
          };
      
      if (comment !== undefined) {
        data['comment'] = comment;
      }
        
      $.ajax({
        "dataType": 'json',
        "type": "POST",
        "cache": false,
        "url": 'segment-vote',
        "data": data,
        "success": function(data) {
           location.reload();
        }
      });

    }

    var show_unclear_modal = function() {
      $(document).off('keyup');
      $('#commentfield').val('');
      $('#myModal').on('shown', function() {$('#commentfield').focus();});
      $('#myModal').modal('show');
    }

    var skip_segment = function() {
      location.reload();
    }

    var toggle_slice = function() {
      if( show_slices ) {
        show_slices = false;
        hide_slices_image();
      } else {
        show_slices = true;
        show_slices_image();
      }
    }

    var register_keyevents = function() {
      $(document).on('keyup', function(e) { 
        if (e.keyCode == 65) { 
          vote( segmentkey, 1 );
        }
        if (e.keyCode == 83) {
          show_unclear_modal();
        }
        if (e.keyCode == 68) {
          vote( segmentkey, 3 );
        }
        if (e.keyCode == 84) {
          toggle_slice();
        }
        if (e.keyCode == 88) {
          skip_segment();
        }
      });      
    }

    $('#buttonskip').on('click', function() {
      skip_segment();
    });

    $('#buttontoggle').on('click', function() {
      toggle_slice();
    });

    $('#buttongood').on('click', function() {
      vote( segmentkey, 1 );
    });

    $('#buttonunclear').on('click', function() {
      show_unclear_modal();
    });

    $('#buttonbad').on('click', function() {
      vote( segmentkey, 3 );
    });

    $('#submitvote').on('click', function() {
      $('#myModal').modal('hide');
      vote( segmentkey, 2, $('#commentfield').val() );
    });

    $('#myModal').on('hidden', function() {
      register_keyevents();
    });

    register_keyevents();

  </script>

</div>

{% endblock %}

